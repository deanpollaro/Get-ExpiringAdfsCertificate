<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
<title>Get-ExpiringAdfsCertificate.ps1</title>
    <link rel="stylesheet" type="text/css" href="styles/github-markdown.css" />
    <link rel="stylesheet" type="text/css" href="styles/github-hjs.css" />
    <style>
        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
        }
    
        @media (max-width: 767px) {
            .markdown-body {
                padding: 15px;
            }
        }
    </style>
    <script src="js/highlight.pack.js"></script>
    <script>
        hljs.configure({ languages: [] });
        hljs.initHighlightingOnLoad();
    </script>
</head>
<body>
    <article class="markdown-body">
<h1>Get-ExpiringAdfsCertificate.ps1</h1>
<h2>SYNOPSIS</h2>
<p>This script checks Active Directory Federation Services (AD FS) certificates and AD FS Relying Party Trust
certificates to see if they expire within a user-specified number of days.</p>
<h2>SYNTAX</h2>
<h3>Default (Default)</h3>
<pre><code>Get-ExpiringAdfsCertificate.ps1 [-AdfsServer &lt;String&gt;] [-ExpirationThreshold &lt;Int32&gt;] [-IgnoreDisabledTrusts]
 [&lt;CommonParameters&gt;]
</code></pre>
<h3>Email</h3>
<pre><code>Get-ExpiringAdfsCertificate.ps1 [-AdfsServer &lt;String&gt;] [-ExpirationThreshold &lt;Int32&gt;] [-IgnoreDisabledTrusts]
 -EmailFrom &lt;String&gt; -EmailTo &lt;String&gt; -SmtpServer &lt;String&gt; [-SmtpPort &lt;Int32&gt;] [-SmtpAuthenticated]
 [-Subject &lt;String&gt;] [-BodyHeader &lt;String&gt;] [-BodyFooter &lt;String&gt;] [-NoOutput] [&lt;CommonParameters&gt;]
</code></pre>
<h3>SaveSmtpCreds</h3>
<pre><code>Get-ExpiringAdfsCertificate.ps1 [-SaveSmtpCreds] [&lt;CommonParameters&gt;]
</code></pre>
<h2>DESCRIPTION</h2>
<p>This script will query AD FS certificates (via Get-AdfsCertficate) and Relying Party Trust
certificates (via Get-AdfsRelyingPartyTrust) and check if the certificates expire within a user-defined
threshold (or the default 30 days if not specified).
It will then output details about expiring certificates, and,<br />
optionally, send an alert email.</p>
<h2>EXAMPLES</h2>
<h3>EXAMPLE 1</h3>
<pre><code>.\Get-ExpiringAdfsCertificate.ps1
</code></pre>
<p>CertType            Name                                        ExpiryDate</p>
<hr />
<p>RP Trust Encryption app.fabrikam.com                            2/14/2018 8:31:43 AM
RP Trust Signing    app.fabrikam.com                            2/14/2018 8:31:43 AM
ADFS                CN=ADFS Encryption - adfs.treyresearch.net  11/12/2018 2:15:12 PM
ADFS                CN=ADFS Signing - adfs.treyresearch.net     11/12/2018 2:15:13 PM</p>
<h3>EXAMPLE 2</h3>
<pre><code>.\Get-ExpiringAdfsCertificate.ps1 -EmailFrom adfs@treyresearch.net -EmailTo noc@treyresearch.net -SmtpServer mail.treyresearch.net -SmtpAuthenticated -NoOutput
</code></pre>
<p>(Does not generate an output, but emails details about expiring certificates to noc@treyresearch.net)</p>
<h2>PARAMETERS</h2>
<h3>-AdfsServer</h3>
<p>The AD FS server to query, if is remote.</p>
<pre><code class="language-yaml">Type: String
Parameter Sets: Default, Email
Aliases:

Required: False
Position: Named
Default value: $env:computername
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-ExpirationThreshold</h3>
<p>The number of days from now to to compare against certificate expiry dates.
If not specified, defaults to 30.</p>
<pre><code class="language-yaml">Type: Int32
Parameter Sets: Default, Email
Aliases:

Required: False
Position: Named
Default value: 30
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-IgnoreDisabledTrusts</h3>
<p>Ignore any Relying Party Trusts that are disabled.</p>
<pre><code class="language-yaml">Type: SwitchParameter
Parameter Sets: Default, Email
Aliases:

Required: False
Position: Named
Default value: False
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-EmailFrom</h3>
<p>From address for alert email.</p>
<pre><code class="language-yaml">Type: String
Parameter Sets: Email
Aliases:

Required: True
Position: Named
Default value: None
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-EmailTo</h3>
<p>To address for alert email.</p>
<pre><code class="language-yaml">Type: String
Parameter Sets: Email
Aliases:

Required: True
Position: Named
Default value: None
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-SmtpServer</h3>
<p>SMTP Server for sending alert email.</p>
<pre><code class="language-yaml">Type: String
Parameter Sets: Email
Aliases:

Required: True
Position: Named
Default value: None
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-SmtpPort</h3>
<p>TCP Port to connect to SMTP server on, if it is different than 25.</p>
<pre><code class="language-yaml">Type: Int32
Parameter Sets: Email
Aliases:

Required: False
Position: Named
Default value: 25
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-SmtpAuthenticated</h3>
<p>Send email using authentication.
Note that you must have previously saved credentials using -SaveSmtpCreds.</p>
<pre><code class="language-yaml">Type: SwitchParameter
Parameter Sets: Email
Aliases:

Required: False
Position: Named
Default value: False
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-Subject</h3>
<p>Custom subject for alert email.</p>
<pre><code class="language-yaml">Type: String
Parameter Sets: Email
Aliases:

Required: False
Position: Named
Default value: &quot;AD FS Certificates on $AdfsServer Expire within $ExpirationThreshold Days&quot;
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-BodyHeader</h3>
<p>Custom header for alert email.</p>
<pre><code class="language-yaml">Type: String
Parameter Sets: Email
Aliases:

Required: False
Position: Named
Default value: (&quot;The following AD FS certificates on $AdfsServer expire within &quot; +
                            &quot;$ExpirationThreshold days:&quot;)
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-BodyFooter</h3>
<p>Custom footer for alert email.</p>
<pre><code class="language-yaml">Type: String
Parameter Sets: Email
Aliases:

Required: False
Position: Named
Default value: Expiring RP Trust certificates will need to be renewed by the company/application on the other end of the Relying Party Trust.&lt;br /&gt;Expiring AD FS certificates will need to be renewed by the AD FS administrator.
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-NoOutput</h3>
<p>Does not output an object; just sends alert email.</p>
<pre><code class="language-yaml">Type: SwitchParameter
Parameter Sets: Email
Aliases:

Required: False
Position: Named
Default value: False
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>-SaveSmtpCreds</h3>
<p>Saves SMTP user name, encrypted password, and keyfile to decrypt password to
Get-ExpiringAdfsCertificate_smtppass.txt, Get-ExpiringAdfsCertificate_smtpkey.txt,
and Get-ExpiringAdfsCertificate_smtpkey.txt, respectively.
These files must exist in the same directory
as this script when you use the -SmtpAuthenticated parameter.</p>
<pre><code class="language-yaml">Type: SwitchParameter
Parameter Sets: SaveSmtpCreds
Aliases:

Required: True
Position: Named
Default value: False
Accept pipeline input: False
Accept wildcard characters: False
</code></pre>
<h3>CommonParameters</h3>
<p>This cmdlet supports the common parameters: -Debug, -ErrorAction, -ErrorVariable, -InformationAction, -InformationVariable, -OutVariable, -OutBuffer, -PipelineVariable, -Verbose, -WarningAction, and -WarningVariable.
For more information, see about_CommonParameters (http://go.microsoft.com/fwlink/?LinkID=113216).</p>
<h2>INPUTS</h2>
<h3>None</h3>
<h2>OUTPUTS</h2>
<h3>Outputs an array of objects containing CertType, Name, and ExpiryDate for each expiring certificate.</h3>
<h3>Can be overridden by using -NoOutput.</h3>
<h2>NOTES</h2>
<p>As the AD FS cmdlets don't support remoting, this must be run directly on an AD FS server.
The account that runs this script will require Administrator rights on the AD FS server.
This script was written on PowerShell 5.1 for ADFS 2016, but should theoretically work with older versions.</p>
<h2>RELATED LINKS</h2>
<p><a href="https://github.com/natescherer/Get-ExpiringAdfsCertificate">https://github.com/natescherer/Get-ExpiringAdfsCertificate</a></p>

    </article>
</body>
</html>
